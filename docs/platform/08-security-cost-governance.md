# 安全与成本治理讲义（从能跑到可持续运行）

## 本周目标
第8周结束后你应该能做到：
1. 建立最小可用的云与K8s安全基线（IAM/RBAC/IRSA/Secret/审计）。
2. 做镜像与供应链基础防护（来源、漏洞扫描、版本追溯）。
3. 设计成本可观测与治理机制（按环境/服务拆分成本）。
4. 输出可执行的治理SOP（发现问题 -> 修复 -> 复查）。
5. 在公司里听懂并使用：`FinOps`、`Tagging`、`Showback`、`Rightsizing`、`Least Privilege`。

---

## 先记住一句话
安全和成本不是“额外工作”，而是平台稳定运行的基础约束。

---

## 讲义知识地图（模块）
1. 模块1：安全治理总览（云侧 + 集群侧）。
2. 模块2：IAM/RBAC/IRSA 权限收敛。
3. 模块3：镜像与供应链安全。
4. 模块4：审计与合规最小闭环。
5. 模块5：成本可观测（标签、分摊、预算告警）。
6. 模块6：成本优化动作（计算、存储、流量、日志）。
7. 模块7：治理SOP输出 + 演练复盘。

---

## 模块1：安全治理总览

## 1.1 云侧安全重点
1. IAM 最小权限。
2. 账号与环境隔离（dev/stage/prod）。
3. 网络边界控制（VPC、SG、NACL）。
4. 审计日志（CloudTrail）。
5. 数据加密（KMS）。

## 1.2 集群侧安全重点
1. RBAC 最小授权。
2. ServiceAccount 隔离。
3. IRSA 替代 AK/SK。
4. Secret 管理与轮换。
5. NetworkPolicy 隔离东西向流量。

## 1.3 “三层防线”思路
1. 预防：权限/策略/基线。
2. 检测：日志/告警/审计规则。
3. 响应：Runbook/隔离/回滚。

## 1.4 模块1 验收
1. 你能画出“云侧+集群侧”安全职责边界。
2. 你能说出 5 个最优先基线项。

---

## 模块2：权限治理（IAM + RBAC + IRSA）

## 2.1 IAM 收敛 checklist
1. 禁止使用 root 做日常操作。
2. 禁止长期共享 AK/SK。
3. 策略避免 `Action:*` + `Resource:*`。
4. 定期审查未使用权限。

## 2.2 RBAC 收敛 checklist
1. 不随意给 `cluster-admin`。
2. 按 namespace 授权。
3. 应用独立 ServiceAccount。
4. 用 `kubectl auth can-i` 验证权限边界。

## 2.3 IRSA 治理 checklist
1. 每个服务对应独立 IAM Role。
2. Role 只允许必须 AWS API。
3. 资源 ARN 精确到桶/队列/主题。

## 2.4 权限审查示例问法（开会常用）
1. 这个服务为什么需要写 S3？
2. 这个 Role 是否可以收敛到具体 bucket 前缀？
3. 这个 namespace 是否有越权读写别的业务资源？

## 2.5 模块2 验收
1. 你能把一个“过大权限”策略收敛到最小权限。
2. 你能输出一个权限审查清单。

---

## 模块3：镜像与供应链安全

## 3.1 为什么供应链安全重要
你部署的不是源代码，而是镜像产物。镜像来源不可信，生产就不可信。

## 3.2 最小可用基线
1. 只允许来自受信仓库（ECR）。
2. 镜像 tag 可追溯到 commit SHA。
3. 开启镜像漏洞扫描（ECR 扫描）。
4. 禁止使用过旧/未知来源基础镜像。

## 3.3 Dockerfile 安全实践
1. 使用明确版本基础镜像。
2. 删除构建中不必要工具。
3. 不把密钥写进镜像。
4. `.dockerignore` 排除敏感文件。

## 3.4 漏洞处理优先级建议
1. Critical：立即修复。
2. High：评估影响后优先修复。
3. Medium/Low：纳入迭代节奏。

## 3.5 模块3 验收
1. 你能说出镜像“可信链路”最少要件。
2. 你能解释为什么 tag 必须可追溯。

---

## 模块4：审计与合规闭环

## 4.1 最小审计数据源
1. CloudTrail：谁在什么时间做了什么 API 操作。
2. EKS 审计日志（按需开启）。
3. GitHub 审计（谁触发了发布/改了流水线）。

## 4.2 你要关注的高风险事件
1. 权限策略突然扩大。
2. 关键资源被删除或公网暴露。
3. 生产环境被非审批流程变更。

## 4.3 审计闭环模板
1. 事件发现。
2. 影响评估。
3. 临时止损（撤销权限/回滚变更）。
4. 根因定位。
5. 基线补丁（策略或流程修正）。

## 4.4 模块4 验收
1. 你能讲清 CloudTrail 在平台治理里的作用。
2. 你能写出一条“高风险变更”的响应流程。

---

## 模块5：成本可观测（FinOps 入门）

## 5.1 先理解三个词
1. Showback：展示成本给团队，不一定直接计费。
2. Chargeback：按团队/项目分摊真实成本。
3. Unit Cost：单位业务成本（如每千次请求成本）。

## 5.2 成本拆分必须先做标签
推荐统一 tag：
1. `env=dev|stage|prod`
2. `team=infra|ai-platform|...`
3. `service=week3-api`
4. `owner=<name>`
5. `cost-center=<id>`

没有标签，后面大部分成本优化都做不精确。

## 5.3 AWS 成本工具最小组合
1. AWS Budgets（预算与告警）。
2. Cost Explorer（趋势分析）。
3. CUR（明细账单，进阶）。

## 5.4 模块5 实操建议
1. 给关键资源补齐 tag。
2. 建一个月度预算告警（总额 + 服务级）。
3. 每周看一次成本波动 Top3。

## 5.5 模块5 验收
1. 你能按 env/service 看到成本分布。
2. 你能解释最近一周成本变化原因。

---

## 模块6：成本优化动作（能省钱也不降稳定）

## 6.1 计算成本优化
1. Rightsizing：实例规格与负载匹配。
2. HPA/VPA：根据流量自动扩缩。
3. 非生产环境定时关停。

## 6.2 存储成本优化
1. S3 生命周期策略（热 -> 冷 -> 归档）。
2. 日志保留天数分级（dev 短、prod 合规期）。
3. 清理废弃快照与未用卷。

## 6.3 网络与LB成本优化
1. 减少不必要公网流量。
2. 清理闲置 ALB/NLB。
3. 检查跨AZ流量与架构放置。

## 6.4 可观测性成本优化
1. 降低无价值日志量。
2. 关键日志保留，低价值日志采样。
3. Metrics 维度不过度爆炸。

## 6.5 模块6 验收
1. 你能提出 3 条不影响稳定性的降本动作。
2. 你能说明每条动作的风险和验证方式。

---

## 模块7：治理SOP输出 + 演练

## 7.1 你要产出的 4 份文档
1. 权限治理清单（IAM/RBAC/IRSA）。
2. 镜像与供应链基线。
3. 成本治理周报模板。
4. 安全/成本异常处理 Runbook。

## 7.2 必做演练
1. 故意创建一个过大权限策略，做收敛修复。
2. 模拟镜像漏洞告警，执行修复流程（升级基础镜像）。
3. 模拟成本突增，按 tag 定位到服务并提出修正。

## 7.3 周复盘模板
1. 本周收敛了哪些权限风险。
2. 本周识别了哪些成本浪费。
3. 哪些治理动作自动化程度还不够。
4. 第9周进入 Bedrock 前需要补的治理能力。

---

## 公司沟通可直接说的话术
1. “先把权限收敛到最小可用，再看是否影响交付效率。”
2. “镜像必须来自受信仓库并可追溯 commit，供应链风险要前置。”
3. “成本分析先按 env/team/service 打标签，否则无法精准治理。”
4. “这次成本上涨不是总量问题，是某服务日志量异常导致。”
5. “安全和成本都要形成 SOP，不靠个人经验临时救火。”

---

## 第8周自测题（含答案）

## 题目
1. 为什么说最小权限是平台治理第一原则？
2. IRSA 相比 AK/SK 在治理上有什么优势？
3. 镜像供应链最少要做哪三件事？
4. CloudTrail 在治理中最关键的价值是什么？
5. Showback 和 Chargeback 的区别是什么？
6. 没有统一 tag 为什么成本治理几乎做不动？
7. Rightsizing 是什么，为什么不能只看峰值？
8. 日志成本优化为什么要做分级保留？
9. 如何平衡“降本”和“稳定性”？
10. 一条好的治理SOP应该包含哪些步骤？

## 参考答案
1. 因为它直接决定越权风险和攻击面大小。
2. 无长期密钥、服务级隔离、可审计。
3. 受信来源、漏洞扫描、版本可追溯。
4. 可追踪关键API操作主体、时间和行为。
5. Showback 仅展示，Chargeback 真实分摊计费。
6. 因为无法按团队/服务/环境分解责任和优化对象。
7. 按实际负载匹配规格，避免长期过配浪费。
8. 不同环境和日志价值不同，统一长留会高成本低收益。
9. 每条优化都要配验证指标和回退方案。
10. 发现、评估、止损、修复、验证、复盘。

---

## 第8周完成标准（80%）
满足以下 7 条即合格：
1. 有权限治理清单并完成一次收敛。
2. 镜像安全基线可执行（扫描、来源、追溯）。
3. 建立审计事件响应最小流程。
4. 成本可按 env/service 分析。
5. 有预算告警并能解释波动原因。
6. 至少落地 2 条降本动作并验证效果。
7. 输出治理SOP并完成一次演练。

---

## 第9周衔接
下周进入 Bedrock，你会把治理能力带进 AI 服务：
1. 模型调用权限与审计。
2. Prompt/Response 安全边界。
3. 成本和延迟观测进入 AI 场景。


---

## 讲义补充：知识图谱
1. 核心概念：先建立定义，再建立关系，再落实到可执行动作。
2. 工程路径：先跑通最小链路，再补安全和可观测，最后再做优化。
3. 质量标准：可复现、可观测、可回滚、可审计。

## 讲义补充：高频误区
1. 只看功能演示，不做失败路径与回滚设计。
2. 只有命令清单，没有“为什么这样做”的解释。
3. 只有部署动作，没有权限边界和成本约束。
4. 只做一次跑通，没有沉淀可复用模板。

## 讲义补充：进阶实践清单
1. 把本讲义的关键配置全部放进 Git 并走 PR 审核。
2. 为每个关键动作补一条自动化检查（lint/test/policy/check）。
3. 给每次变更写最小复盘：变更点、风险、回滚点、验证结果。
4. 在团队内做一次 10 分钟分享，验证你是否真的掌握。

## 讲义补充：学习验收方式
1. 能口头讲清关键概念和关系图。
2. 能独立完成一次从配置到验证到排错的闭环。
3. 能回答“为什么这么设计、风险在哪里、如何回滚”。
4. 能把内容迁移到你们真实业务场景。
