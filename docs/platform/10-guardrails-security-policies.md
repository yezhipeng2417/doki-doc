# Bedrock Guardrails 与安全策略讲义（把 AI 风险可配置化）

## 本周目标
第10周结束后你应该能做到：
1. 解释 Guardrails 在 AI 系统中的作用边界。
2. 为输入和输出分别配置内容安全策略（敏感话题、违规内容、PII）。
3. 使用 ApplyGuardrail 独立调用，对非 Bedrock 产出的文本也做策略校验。
4. 建立 Guardrails 指标、告警和排障流程。
5. 在公司里听懂并使用：`policy`、`intervention`、`blocked/allowed`、`false positive`。

---

## 先记一句话
Guardrails 不是“让模型更聪明”，而是“让系统更安全、更可控”。

---

## 讲义知识地图（模块）
1. 模块1：Guardrails 基础与策略边界。
2. 模块2：输入策略（Prompt 输入拦截）。
3. 模块3：输出策略（模型输出审查）。
4. 模块4：PII 与敏感主题策略。
5. 模块5：ApplyGuardrail 独立调用与服务集成。
6. 模块6：指标、告警与误判调优。
7. 模块7：策略版本化、灰度与复盘。

---

## 模块1：Guardrails 基础

## 1.1 Guardrails 解决什么问题
1. 防止高风险输入直接进入模型。
2. 防止高风险输出直接返回用户。
3. 把安全策略从代码逻辑中抽离成“可配置规则”。

## 1.2 Guardrails 不解决什么
1. 不替代业务权限控制。
2. 不替代模型评测。
3. 不保证 100% 无误判。

## 1.3 策略设计四步法
1. 定义风险类别（违法、暴力、自残、隐私泄露等）。
2. 定义拦截动作（阻断、替换、警告、人工审核）。
3. 定义可接受误判率。
4. 建立复盘机制（误杀和漏放都要跟踪）。

## 1.4 模块1 验收
1. 你能解释 Guardrails 与普通业务校验的分工。
2. 你能给出你们组的三类高优先风险。

---

## 模块2：输入侧策略

## 2.1 输入侧为什么重要
很多风险在用户输入阶段就能拦下，成本低、影响可控。

## 2.2 输入策略建议
1. 违规主题拒绝（例如暴力、违法指导）。
2. 指令注入防护（prompt injection 基础规则）。
3. 明确系统边界（超范围请求直接拒绝）。

## 2.3 工程实现思路
调用链建议：
1. 用户输入 -> Guardrails 输入检查。
2. 通过才调用 LLM。
3. 未通过返回统一拒绝模板。

## 2.4 拒绝模板建议
统一口径，避免多处逻辑不一致：
1. 简洁说明“无法提供该内容”。
2. 给一个安全替代建议。
3. 不暴露策略细节与阈值。

## 2.5 模块2 验收
1. 你有统一的输入拒绝模板。
2. 你能区分“拒绝”和“降级回答”场景。

---

## 模块3：输出侧策略

## 3.1 输出侧为什么仍然需要审查
输入干净不代表输出安全，模型仍可能产生不当内容或幻觉性高风险建议。

## 3.2 输出侧策略建议
1. 违规内容阻断。
2. 高风险主题改写为安全答复。
3. 对不确定回答加免责声明或提示人工确认。

## 3.3 输出处理分级动作
1. `allow`：直接返回。
2. `filter`：清理敏感片段后返回。
3. `block`：阻断并返回安全提示。
4. `escalate`：进入人工复核队列（高风险业务）。

## 3.4 模块3 验收
1. 你能设计输入与输出双重拦截链路。
2. 你能解释为什么只做输入拦截不够。

---

## 模块4：PII 与敏感主题

## 4.1 PII 治理目标
1. 识别个人敏感信息。
2. 控制是否允许原样输出。
3. 在日志里脱敏记录。

## 4.2 最小PII策略
1. 检测邮箱、手机号、身份证类字段。
2. 输出阶段做掩码（例如 `a***@xx.com`）。
3. 日志中永不记录原始敏感字段。

## 4.3 敏感主题策略分级
1. 强拒绝：违法、有害行为指导。
2. 软拒绝：转向安全教育与帮助资源。
3. 受控回答：允许基础科普，不给操作级细节。

## 4.4 模块4 验收
1. 你能写出 PII 处理规则（检测、掩码、日志）。
2. 你能给出三类敏感主题处理动作。

---

## 模块5：ApplyGuardrail 独立调用

## 5.1 为什么需要独立调用
并不是所有文本都来自 Bedrock 模型输出。你可能还要审核：
1. 用户上传文本。
2. 外部系统回传内容。
3. Agent 工具结果。

ApplyGuardrail 可以把 Guardrails 当成通用安全网关。

## 5.2 集成模式建议
1. 入口审核：请求入站先过 ApplyGuardrail。
2. 出口审核：响应出站再过一次。
3. 双向日志：记录命中策略类型与处理动作。

## 5.3 伪代码流程
```python
def secure_chat(user_text):
    in_result = apply_guardrail(user_text)
    if in_result.blocked:
        return safe_reject()

    llm_resp = call_bedrock(user_text)

    out_result = apply_guardrail(llm_resp)
    if out_result.blocked:
        return safe_reject()
    return out_result.sanitized_text or llm_resp
```

## 5.4 模块5 验收
1. 你能说出 ApplyGuardrail 适合的 3 个场景。
2. 你能画出“入站+出站”审查链路图。

---

## 模块6：指标、告警、误判调优

## 6.1 最小指标集
1. `guardrail_requests_total`
2. `guardrail_blocked_total`
3. `guardrail_filtered_total`
4. `guardrail_error_total`
5. `guardrail_latency_ms`
6. `false_positive_count`（需要人工标注支持）

## 6.2 关键比率
1. 拦截率 = blocked / total
2. 误判率 = false_positive / reviewed
3. 漏放率 = false_negative / reviewed

## 6.3 告警建议
1. `guardrail_error_total` 异常上升。
2. 拦截率突然变化（可能策略配置错误）。
3. 误判率超过阈值（用户体验风险）。

## 6.4 调优顺序
1. 先看误杀（false positive）影响面。
2. 再看漏放（false negative）风险级别。
3. 每次只改一个策略项，观察一段时间再继续。

## 6.5 模块6 验收
1. 你有 Guardrails 关键指标和告警。
2. 你能解释一次“拦截率突增”可能原因。

---

## 模块7：版本化、灰度、复盘

## 7.1 为什么要版本化
策略改动会直接影响用户体验和风险暴露，必须可回滚可审计。

## 7.2 版本管理建议
1. policy 文件进入 Git 管理。
2. 每次改动走 PR 审核。
3. 每版记录：改了什么、为什么、预期影响。

## 7.3 灰度发布建议
1. 先在 dev 启用。
2. 再在小流量 stage 验证。
3. 最后上 prod 全量。

## 7.4 复盘模板
1. 命中最多的策略是哪些。
2. 误判集中在哪些场景。
3. 用户投诉/业务影响如何。
4. 下一个版本的策略优化点。

## 7.5 模块7 验收
1. 你能输出一份 Guardrails 策略版本变更记录。
2. 你能描述一条完整灰度到全量流程。

---

## 公司沟通可直接说的话术
1. “Guardrails 是策略层，不是模型能力层，我们会独立评估两者效果。”
2. “输入和输出都做审查，避免单点防护失效。”
3. “PII 在日志里一律脱敏，不记录原始敏感值。”
4. “策略改动走版本化和灰度，避免一次性影响全部流量。”
5. “我们会用误判率和漏放率双指标来调策略，不只看拦截率。”

---

## 第10周自测题（含答案）

## 题目
1. Guardrails 的核心目标是什么？
2. 为什么输入和输出都要做策略审查？
3. ApplyGuardrail 独立调用适用于哪些场景？
4. PII 治理最小闭环包含哪三步？
5. 拦截率上升一定是好事吗？为什么？
6. false positive 和 false negative 的区别？
7. 为什么策略一定要版本化与灰度发布？
8. 什么时候应该 block，什么时候应该 filter？
9. 如何避免拒绝提示泄露内部策略细节？
10. 你会如何向业务解释“这次被拦截”？

## 参考答案
1. 降低输入输出风险，让系统安全可控。
2. 因为风险既可能来自用户输入，也可能由模型输出产生。
3. 用户上传文本、外部数据回传、Agent 工具输出等。
4. 检测、处理（掩码/阻断）、日志脱敏审计。
5. 不一定，可能策略过严导致误杀。
6. 误判是本应放行却拦截；漏判是本应拦截却放行。
7. 为了可审计、可回滚、可控影响范围。
8. 高风险直接 block，低风险可控内容可 filter。
9. 使用统一通用拒绝模板，不回显规则阈值细节。
10. 说明触发了安全策略并提供合规替代路径。

---

## 第10周完成标准（80%）
满足以下 7 条即合格：
1. 有输入与输出双向 Guardrails 链路。
2. 有 PII 检测与日志脱敏规则。
3. ApplyGuardrail 已集成到至少一个流程。
4. 有关键指标与告警（错误率、拦截率、误判率）。
5. 有策略版本化与PR审查流程。
6. 能完成一次策略灰度并观察效果。
7. 输出一份策略调优复盘报告。

---

## 第11周衔接
下周进入 Agents/AgentCore，你会把 Guardrails 嵌入到 Agent 调用链：
1. 用户请求入站审查。
2. Agent 工具调用权限边界。
3. 工具返回内容出站审查。


---

## 讲义补充：知识图谱
1. 核心概念：先建立定义，再建立关系，再落实到可执行动作。
2. 工程路径：先跑通最小链路，再补安全和可观测，最后再做优化。
3. 质量标准：可复现、可观测、可回滚、可审计。

## 讲义补充：高频误区
1. 只看功能演示，不做失败路径与回滚设计。
2. 只有命令清单，没有“为什么这样做”的解释。
3. 只有部署动作，没有权限边界和成本约束。
4. 只做一次跑通，没有沉淀可复用模板。

## 讲义补充：进阶实践清单
1. 把本讲义的关键配置全部放进 Git 并走 PR 审核。
2. 为每个关键动作补一条自动化检查（lint/test/policy/check）。
3. 给每次变更写最小复盘：变更点、风险、回滚点、验证结果。
4. 在团队内做一次 10 分钟分享，验证你是否真的掌握。

## 讲义补充：学习验收方式
1. 能口头讲清关键概念和关系图。
2. 能独立完成一次从配置到验证到排错的闭环。
3. 能回答“为什么这么设计、风险在哪里、如何回滚”。
4. 能把内容迁移到你们真实业务场景。
